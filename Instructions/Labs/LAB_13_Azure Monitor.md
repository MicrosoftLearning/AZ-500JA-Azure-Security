---
lab:
    title: '13 - Azure Monitor'
    module: 'モジュール 04 - セキュリティ操作の管理'
---

# ラボ 13: Azure Monitor
# 受講生用ラボ マニュアル

## ラボのシナリオ

仮想マシンのパフォーマンスを監視するという概念実証を作成するように求められました。具体的には、次のことを行います。

- テレメトリとログを収集できるように仮想マシンを構成します。
- 収集できるテレメトリとログを表示します。
- データの使用方法とクエリ方法を示します。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: Azure Monitor を使用して Azure 仮想マシンからデータを収集する

### 演習 1: Azure Monitor を使用して Azure 仮想マシンからデータを収集する

### 演習のタイミング: 20 分

この演習では、次のタスクを行います。 

- タスク 1: Azure Virtual Machine をデプロイする 
- タスク 2: Log Analytics ワークスペースの作成
- タスク 3: Log Analytics 仮想マシン拡張機能を有効にする
- タスク 4: 仮想マシン イベントおよびパフォーマンス データを収集する
- タスク 5: 収集したデータの表示と照会 

#### タスク 1: Azure Virtual Machine をデプロイする

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 を選択します。   

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。 

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次の手順を実行して、このラボで使用するリソース グループを作成します。
  
    ```powershell
    New-AzResourceGroup -Name AZ500LAB131415 -Location 'EastUS'
    ```

    >**注**: このリソース グループは、ラボ 13、14、および 15 に使用されます。 

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次の手順を実行して、新しい Azure Virtual Machine を作成します。 

    ```powershell
    New-AzVm -ResourceGroupName "AZ500LAB131415" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName   "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -OpenPorts 80,3389
    ```

1.  資格情報の入力を求められた場合:

    |設定|値|
    |---|---|
    |ユーザー名| **localadmin** |
    |パスワード| **Pa55w.rd1234** |

    >**注**: デプロイが完了するのを待ちます。 

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次のコマンドを実行して、**myVM** という名前の仮想マシンが作成され、その 「**ProvisioningState**」 が 「**Succeeded**」 であることを確認します。

    ```powershell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'AZ500LAB131415' | Format-Table
    ```

1. 「Cloud Shell」 ウィンドウを閉じます。 

#### タスク 2: Log Analytics ワークスペースの作成

このタスクでは、Log Analytics ワークスペースを作成します。 

1. Azure portal ページの上部にある 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、「**Log Analytics ワークスペース**」と入力し、**Enter** キーを押します。

1. 「**Log Analytics ワークスペース**」 ブレードで、「**+ 追加**」 をクリックします。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**基本**」 タブで 、次の設定を指定します (既定値を他のユーザーのままにします)。   

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ| **AZ500LAB131415*|
    |名前|有効で、グローバルにユニークな任意の名前|
    |リージョン| **(US) 米国東部** |

1. 「**次へ: **」 をクリックします。「**価格レベル**」 の 「**Log Analytics ワークスペースの作成**」 ブレードの 「**価格レベル**」 タブで 、既定の**従量課金制 (GB 2018 ご利用)** の価格レベルを受け入れ 、「**Review + create**」 をクリックします。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**Review + create**」 タブで、「**作成**」 をクリックします。

1. 「**確認して作成**」 をクリックし、「**作成**」 をクリックします。

#### タスク 3: Log Analytics 仮想マシン拡張機能を有効にする

このタスクでは、Log Analytics 仮想マシン拡張機能を有効にします。この拡張機能は、Windows および Linux Virtual Machines に Log Analytics エージェントをインストールします。このエージェントは、仮想マシンからデータを収集し、指定した Log Analytics ワークスペースに転送します。エージェントがインストールされると、自動的にアップグレードされ、常に最新の機能と修正プログラムが提供されます。 

1. Azure portal で、「**Log Analytics ワークスペース**」 ブレードに戻り、ワークスペースの一覧で、前のタスクで作成したワークスペースを表すエントリをクリックします。 

1. 「Log Analytics ワークスペース」 ブレードの 「**ワークスペース データ ソース**」 セクションで、「**Virtual Machines**」 エントリをクリックします。   

    >**注**: エージェントを正常にインストールするには、仮想マシンが実行されている必要があります。

1. 仮想マシンの一覧で、この演習の最初のタスクでデプロイした Azure VM **myVM** を表すエントリを見つけ 、そのエントリが 「**未接続**」 と表示されていることに注意してください。   

1. **myVM** エントリをクリックし、次に 「**myVM**」 ブレードで 「**接続**」 をクリックします。      

1. 仮想マシンが Log Analytics ワークスペースに接続するまで待ちます。

    >**注**: これには数分かかる場合があります。「**myVM**」 ブレードに表示される 「**状態**」 は 「**接続中**」 から 「**このワークスペース**」 に変わります。 

#### タスク 4: 仮想マシン イベントおよびパフォーマンス データを収集する

このタスクでは、Windows システム ログのコレクションといくつかの一般的なパフォーマンス カウンターを構成します。また、使用可能な他のソースも確認します。

1. Azure portal で、この演習で前に作成した Log Analytics ワークスペースに戻ります。

1. 「Log Analytics ワークスペース」 ブレードの 「**設定**」 セクションで、「**詳細設定**」 をクリックします。   

1. 「**詳細設定**」 ブレードで、「**データ**」 をクリックし、Windows イベント ログ、Windows パフォーマンス カウンター、Linux パフォーマンス カウンター、IIS ログ、および Syslog などの利用可能なオプションを確認します。 

1. **Windows イベント ログ**が選択されていることを確認し、「**次のイベント ログからイベントを収集する**」 テキスト ボックスに「**System**」と入力し、「**+**」 をクリックします。

    >**注**: これは、ワークスペースにイベント ログを追加する方法です。その他の選択肢としては、**ハードウェア イベント** や **キー管理サービス** などがあります。  

1. 「**情報**」 チェック ボックスの選択を解除し、「**エラー**」 および 「**警告**」 チェック ボックスをオンのままにします。     

1. 「**Windows パフォーマンス カウンター**」 をクリックします。 

    >**注**: パフォーマンス カウンターの推奨リストがあります。このリストはカスタマイズできます。 

1. 「**選択したパフォーマンス カウンターを追加する**」 をクリックします。 

    >**注**: カウンターが追加され、10 秒の収集サンプル間隔で構成されます。
  
1. 「**詳細設定**」 ブレードのページの上部にある 「**保存**」 をクリックし、確認を承認するには 「**OK**」 をクリックします。

#### タスク 5: 収集したデータの表示と照会

このタスクでは、データ コレクションに対してログ検索を実行します。 

1. Azure portal で、この演習で前に作成した Log Analytics ワークスペースに戻ります。

1. 「Log Analytics ワークスペース」 ブレードの 「**全般**」 セクションで、「**ログ**」 をクリックします。

1. 「ログ」 ブレードで、「**開始**」 をクリックします。   

1. 「**サンプル クエリ**」 ウィンドウで、「**仮想マシン**」 をクリックします

1. 定義済みクエリの一覧を確認し、テストするクエリを特定し、対応する 「**実行**」 ボタンをクリックします。 

    >**注**: **仮想マシンで使用可能なメモリ** というクエリから始めることができます。

1. クエリは、「新しいクエリ」 タブで自動的に開きます。 

    >**注**: Log Analytics では、Kusto クエリ言語が使用されます。既存のクエリをカスタマイズすることも、独自のクエリを作成することもできます。 

    >**注**: 選択したクエリの結果は、クエリ ウィンドウの下に自動的に表示されます。クエリを再実行するには、「**実行**」 をクリックします。 

    >**注**: この仮想マシンは作成されたばかりなので、まだデータが存在しない可能性があります。 

    >**注**: データを異なる形式で表示するオプションがあります。また、クエリの結果に基づいてアラート ルールを作成することもできます。

> 結果: Log Analytics ワークスペースを使用して、データ ソースとクエリ ログを構成しました。 

**リソースをクリーン アップします**

>**注**: Azure Security Center ラボおよび Azure Sentinel ラボに必要なリソースは、このラボから削除しないでください。
 
