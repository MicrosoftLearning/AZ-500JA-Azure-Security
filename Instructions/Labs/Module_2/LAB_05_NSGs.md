---
lab:
    title: 'ラボ 5 - NSG'
    module: 'モジュール 2 - プラットフォーム保護を実装する'
---

# モジュール 2：ラボ 5 - NSG


ネットワークセキュリティグループを使用して、仮想ネットワークサブネットとの間で送受信されるネットワークトラフィックをフィルター処理できます。ネットワークセキュリティグループには、IPアドレス、ポート、およびプロトコルでネットワークトラフィックをフィルタリングするセキュリティルールが含まれています。セキュリティルールは、サブネットに展開されたリソースに適用されます。このチュートリアルには、下記を説明します：

- ネットワーク セキュリティ グループとセキュリティ規則を作成する
- 仮想ネットワークを作成し、ネットワーク セキュリティ グループをサブネットに関連付ける
- 仮想マシン（VM）をサブネットにデプロイする
- トラフィックフィルターをテストする


## 演習 1：Azure portal を使用してネットワーク セキュリティ グループでネットワーク トラフィックをフィルタリングする

### タスク 1：  仮想ネットワークを作成する

1.  Azure portal の左上隅にある **+ リソースの作成** を選択します。
2.  **「ネットワーク」** を選択してから、**仮想ネットワーク** を選択します。
3.  次の情報を入力または選択し、残りの設定についてはデフォルトを受け入れてから、**作成** を選択します：

    | 設定                 | 値                                              |
    | ---                     | ---                                                |
    | 名前                    | myVirtualNetwork                                   |
    | アドレス空間           | 10.0.0.0/16                                        |
    | サブスクリプション            | サブスクリプションを選択します。                          |
    | リソース グループ          | **新規作成** を選択し、*MyResourceGroup* と入力します。 |
    | 保存先                | **米国東部** と入力します。                                |
    | サブネット- 名前            | mySubnet                                           |
    | サブネット - アドレス範囲  | 10.0.0.0/24                                        |

### タスク 2：  アプリケーション セキュリティ グループを作成する


アプリケーション セキュリティ グループを使用すると、Web サーバーなど、同様の機能を持つサーバーをグループ化できます。


1.  Azure portal の左上隅にある **+ リソースの作成** を選択します。
2.  **マーケットプレイスを検索** ボックスで、*アプリケーション セキュリティ グループ* を入力します。**アプリケーション セキュリティ グループ** が検索結果に表示されたら、それを選択して、**すべて** で **アプリケーション セキュリティ グループ** を再び選択してから、**作成** を選択します。
3.  次の情報を入力または選択してから、**作成** を選択します。

    | 設定        | 値                                                         |
    | ---            | ---                                                           |
    | 名前           | myAsgWebServers                                               |
    | サブスクリプション   | サブスクリプションを選択します。                                     |
    | リソース グループ | **既存の使用** を選択してから、**myResourceGroup** を選択します。 |
    | 保存先       | 米国東部                                                       |

4.  次の値を指定して、手順 3 を再度完了します。

    | 設定        | 値                                                         |
    | ---            | ---                                                           |
    | 名前           | myAsgMgmtServers                                              |
    | サブスクリプション   | サブスクリプションを選択します。                                     |
    | リソース グループ | **既存の使用** を選択してから、**myResourceGroup** を選択します。 |
    | 保存先       | 米国東部                                                       |

### タスク 3：  ネットワーク セキュリティ グループの作成

1.  Azure portal の左上隅にある **+ リソースの作成** を選択します。
2.  **「ネットワーク」** を選択してから、**ネットワーク セキュリティ グループ** を選択します。
3.  次の情報を入力または選択してから、**作成** を選択します。

    |設定|値|
    |---|---|
    |名前|myNsg|
    |サブスクリプション| サブスクリプションを選択します。|
    |リソース グループ | **既存の使用** を選択してから、*myResourceGroup* を選択します。|
    |保存先|米国東部|

### タスク 4：  ネットワーク セキュリティ グループをサブネットに関連付ける

1.  ポータルの最上部にある *リソース、サービス、ドキュメントを検索する* ボックスで、*myNsg* の入力を開始します。検索結果に **myNsg** が表示されたら、それを選択します。
2.  **設定** で、**サブネット** を選択してから、**+ アソシエイト** を選択します。 

3.  **サブネットを関連付ける** で、**仮想ネットワーク** を選択してから、**myVirtualNetwork** を選択します。**サブネット** を選択し、**mySubnet** を選択してから、**OK** を選択します。

### タスク 5：  セキュリティ規則を作成する

1.  **設定** で、**受信セキュリティ規則** を選択してから、**追加** を選択します。

2.  **myAsgWebServers** アプリケーション セキュリティ グループに対して、ポート 80 および 443 を許可するセキュリティ規則を作成します。  **受信セキュリティ規則を追加する** で、次の値を入力または選択し、残りのデフォルトを受け入れてから、**追加** を選択します。

    | 設定                 | 値                                                                                                           |
    | ---------               | ---------                                                                                                       |
    | デスティネーション             | **アプリケーション セキュリティ グループ** を選択してから、**アプリケーション セキュリティ グループ** に **myAsgWebServers** を選択します。  |
    | 宛先ポート範囲 | 80,443 を入力します                                                                                                    |
    | プロトコル                | TCP を選択します                                                                                                      |
    | 名前                    | Allow-Web-All                                                                                                   |

3.  次の値を使用して、手順 2 を再度完了します。

    | 設定                 | 値                                                                                                           |
    | ---------               | ---------                                                                                                       |
    | デスティネーション             | **アプリケーション セキュリティ グループ** を選択してから、**アプリケーションセキュリティグループ** に **myAsgMgmtServers** を選択します。 |
    | 宛先ポート範囲 | 3389 を入力します                                                                                                      |
    | プロトコル                | TCP を選択します                                                                                                      |
    | 優先度                | 110 を入力します                                                                                                       |
    | 名前                    | Allow-RDP-All                                                                                                   |

    このチュートリアルでは、RDP（ポート3389）がインターネットに公開され、*myAsgMgmtServers* アプリケーション セキュリティ グループに割り当てられている VM に割り当てられています。運用環境では、ポート 3389 をインターネットに公開する代わりに、VPN またはプライベート ネットワーク接続を使用して管理する Azure リソースに接続することをお勧めします。


### タスク 6：  仮想マシンを作成する

1.  Azure portal の左上隅にある **+ リソースの作成** を選択します。
2.  **計算** を選択してから、**Windows Server 2016 Datacenter** を選択します。
3.  次の情報を入力または選択し、残りの設定についてはデフォルトを受け入れます。

    |設定|値|
    |---|---|
    |サブスクリプション| サブスクリプションを選択します。|
    |リソース グループ| **既存の使用** を選択して、**myResourceGroup** を選択します。|
    |名前|myVmWeb|
    |保存先| **米国東部** と入力します。|
    |ユーザー名| 選択したユーザー名を入力します。|
    |パスワード| Pa55w.rd1234 |

   

4.  VM のサイズを選択してから、**選択** を選択します。
5.  **「ネットワーク」** で、次の値を選択し、残りのデフォルトを受け入れます。

    |設定|値|
    |---|---|
    |仮想ネットワーク |**myVirtualNetwork** を選択します。|
    |NIC ネットワーク セキュリティ グループ |**詳細** を選択します。|
    |パブリック受信ポート|**なし** を選択します。 |

6.  左下隅にある **「確認および作成」** を選択し、**「作成」** を選択して VM デプロイを開始します。

### タスク 7：  2 つ目の VM を作成する

上記の手順 1 ? 6 を再度完了しますが、手順 3 では VM に *myVmMgmt* と名前を付けます。VM がデプロイを完了するまでに数分かかります。VM がデプロイされるまで、次の手順に進まないでください。

### タスク 8：  ネットワーク インターフェイスを ASG に関連付ける


ポータルが VM を作成すると、VM ごとにネットワーク インターフェイスが作成され、ネットワーク インターフェイスが VM に接続されました。前に作成したアプリケーション セキュリティ グループのいずれかに、各 VM のネットワーク インターフェイスを追加します。


1.  ポータルの最上部にある *リソース、サービス、ドキュメントを検索する* ボックスで、*myVmWeb* の入力を開始します。検索結果に **myVmWeb** VM が表示されたら、それを選択します。
2.  **設定** で、 **「ネットワーク」** を選択します。  **アプリケーション セキュリティ グループを構成する** を選択し、**アプリケーション セキュリティ グループ** に **myAsgWebServers** を選択してから、**保存** を選択します。

3.  手順 1 と 2 を再度完了し、 **myVmMgmt** VM を検索して、**myAsgMgmtServers** ASG を選択します。

### タスク 9：  トラフィックフィルターをテストする

1.  *myVmMgmt* VM に接続します。ポータルの上部にある検索ボックスに *myResourceGroup* と入力します。検索結果に **myVmMgmt** が表示されたら、それを選択します。**接続** ボタンを選択します。
2.  **「RDP ファイルのダウンロード」** を選択します。
3.  ダウンロードした RDP ファイルを開き、**接続** を選択します。VM の作成時に指定したユーザー名とパスワードを入力します。VM 作成時に入力した資格情報を指定するには、 **その他** を選択してから、**別のアカウントを使用する** を選択する必要があります。
4.  **OK** を選択します。
5.  サインイン プロセス中に証明書の警告が表示されることがあります。警告が表示されたら、**はい** または **続行** を選択して、接続を続行します。

    ポート 3389 はインターネットから *myVmMgmt* VM に接続されているネットワーク インターフェースがある *myAsgMgmtServers* アプリケーションセキュリティグループへの受信を許可されているため、接続は成功します。

6.  PowerShell セッションで次のコマンドを入力して *myVmMgmt* VM から *myVmWeb* に接続します。

    ```powershell
    mstsc /v:myVmWeb
    ```

    同じ仮想ネットワーク内の VM はデフォルトで任意のポートを介して相互に通信できるため、myVmMgmt VM から myVmWeb VM に接続できます。ただし、*myAsgWebServers* のセキュリティ規則は、デフォルトで、インターネットからのポート 3389 の受信は許可せず、インターネットからの受信トラフィックはすべてのリソースに対して拒否されるため、インターネットから *myVmWeb* VM へのリモート デスクトップ接続を作成することはできません。

7.  *myVmWeb* VM で Microsoft IIS をインストールするには、*myVmWeb* VM での PowerShell セッションから次のコマンドを入力します。

    ```powershell
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    ```

8.  IIS のインストールが完了したら、*myVmWeb* VM から切断します。これにより *myVmMgmt* VM リモートデスクトップ接続を保ちます。
9.  *myVmMgmt* VM から切断します。
10.  Azure portal の最上部にある *リソース、サービス、ドキュメントを検索する* ボックスで、お使いのコンピューターから *myVmWeb* の入力を開始します。検索結果に **myVmWeb** が表示されたら、それを選択します。お使いの VM の **パブリック IP アドレス** に注意してください。次の図に示すアドレスは 137.135.84.74 ですが、お使いのアドレスは異なります。

       ![スクリーンショット](../Media/Module-2/e3bbd69d-95d0-4b3b-98ce-714d30b4d1ef.png)
  
11.  *myVmWeb* Web サーバーからインターネットへアクセスできることを確認するには、お使いのコンピューターでインターネットブラウザーを開き、「http：//<public-ip-address-from-previous-step>」を参照します。インターネットから *myVmWeb* VM に接続されているネットワークインターフェースがある *myAsgWebServers* アプリケーション セキュリティ グループへの、ポート 80 での受信が許可されているため、IIS のようこそ画面が表示されます。


| 警告：続行する前に、このラボで使用したすべてのリソースを削除する必要があります。  **Azure Portal** でこれを行うには、**リソース グループ** をクリックします。  作成したリソース グループを選択します。  リソース グループ ブレードで、**リソース グループを削除** をクリックし、リソース グループ名を入力して、**削除** をクリックします。  作成した可能性のある追加のリソース グループに対してプロセスを繰り返します。**これを行わないと、他のラボで問題が発生する可能性があります。** |
| --- |

**結果**：これで、このラボを完了しました。
