---
lab:
    title: 'ラボ 17 - Azure Automation を使用して Windows の更新を管理する'
    module: 'モジュール 2 - プラットフォーム保護を実装する'
---

# モジュール 2：ラボ 17 - Azure Automation を使用して Windows の更新を管理する


**シナリオ**

Update Management ソリューションを使用して、仮想マシンの更新とパッチを管理できます。このチュートリアルでは、利用可能な更新プログラムのステータスをすばやく評価し、必要な更新プログラムのインストールをスケジュールし、デプロイの結果を確認し、更新プログラムが正常に適用されることを確認するアラートを作成する方法を学習します。

## 演習 1：Azure Automation を使用して、Windows Update を管理します。

### タスク 1：リソース グループを作成する

1.  Azure ハブメニューで **リソース グループ** をクリックします。

1.  **追加** をクリックします。
1.  リソース グループに **RunBooks** と名前を付ける
1.  リージョンを **米国東部** に変更する

### タスク 2：Automation アカウントを作成する

1.  Azure の左上隅にある **リソースの作成** ボタンをクリックします。

1.  **管理ツール** を選択してから、**Automation** を選択します。

1.  次の情報を入力します。

     |名前|リソース グループ| 保存先 | Azure Run As アカウントを作成する
     |--------|--------|--------|--------|
     |MyAutomation|RunBooks|EastUS|はい

1.  作成をクリックする

1.  デプロイが完了したら、**すべてのサービス** をクリックし、**Automation アカウント** を選択して、作成した Automation アカウントを選択します。

### タスク 3：使用する VM を作成する

1.  **Virtual Machines** をクリックする

1.  **追加** をクリックします。

1.  以下の詳細を入力して、VM を作成する


     |リソース グループ|仮想マシン名|リージョン|イメージ|ユーザー名|パスワード|
     |--------|--------|------|-------------------|----------|------------|
     |RunBooks|UpdateVM|EastUS|Windows Server 2016|localadmin|Pa55w.rd1234|


1.  **Review+Create** をクリックします。

1.  **作成** をクリックします

**注記：**VM がデプロイされるのを待ってから次に進む


### タスク 4：Update Management を有効にする

1.  ポータルで、仮想マシンをクリックする

1.  前の手順で作成した VM を選択する

1.  **操作** で、**Update Management** をクリックする

1.  **有効にする** をクリックする

 この VM に対して Update Management が有効になっているかどうかを確認するために検証が実行されます。この検証には、Azure Log Analytics ワークスペースとリンクされた Automation アカウントのチェック、および Update Management ソリューションがワークスペースにあるかどうかのチェックが含まれます。

 Log Analytics ワークスペースは、Update Management などの機能やサービスによって生成されるデータを収集するために使用されます。ワークスペースは、複数のソースからのデータを確認および分析するための単一の場所を提供します。

 検証プロセスでは、VM に Microsoft Monitoring Agent（MMA）および Automation Hybrid Runbook Worker がプロビジョニングされているかどうかも確認されます。このエージェントは Azure Automation と通信し、更新ステータスに関する情報を取得するために使用されます。エージェントは、Azure Automation サービスと通信し、更新をダウンロードするためにポート 443 が開いている必要があります。

 オンボーディング中に次のいずれかの前提条件が見つからない場合は、自動的に追加されます。

  - **Log Analytics ワークスペース**
  - **Automation アカウント**
  - **Hybrid Runbook Worker (VM で有効)**
<br>

**注記**：ソリューションを有効にするには最大数分かかる場合があります。この間、ブラウザウィンドウを閉じないでください。ソリューションを有効にすると、VM での更新の欠落に関する情報が Azure Monitor ログに流れます。データが分析に使用できるようになるまで、30 分から 6 時間かかります。


### タスク 5：更新評価の表示

1.  Update Management を有効にした後、 **Update Management** ペインが開きます

1.  更新がない場合、ここに表示されます

    **注記**：VM が前の手順で作成されている場合、これは Microsoft のテンプレート VM であり、すべての最新の Windows アップデートが含まれるため、VM に必要なアップデートが表示されない場合があります


1.  利用可能な更新がある場合は、Inforamtion Link 列にリンクが表示され、その更新の詳細を表示したり、Microsoft からの更新の Kb 記事にリンクしたりできます。

### タスク 6：アラートを設定する

1.  以前に作成したリソース グループに戻る

1.  **MyAutomation** Automation アカウントを選択する

1.  **モニタリング** で **アラート** をクリックする 

1.  **新規アラートルール** をクリックする

1.  **条件を追加** をクリックする

1.  リストから **更新プログラムの展開マシンの合計実行回数** を選択する

1.  **Runbook 名** と **状態** の隣にある **チェックボックスを選択** をクリックする

1.  **アラートロジック** で、**しきい値** に **1** を入力する

1.  完了をクリックする 

1.  **アラートの詳細** で、**アラートルール名** に **UpdateAlert** と入力する

1.  重要度を **Sev2** に設定する

1.  **アクション グループ** で **新規作成** を選択する

1.  次の詳細を入力する 

     |アクション グループ名| 略称|リソース グループ| アクション名|アクションタイプ|
     |-----------------|-----------|--------------|------------|-----------|
     |VM 更新アクション グループ|VMup|Runbooks|電子メール|メール/SMS/プッシュ/音声


1.  メールの横にある **詳細を編集する** をクリックし、アラートに使用される **あなたのメール** に入力する

1.  **OK** をクリックします

1.  アクション グループで **既存を選択** をクリックする

1.  アクション グループを選択する

1.  **作成** をクリックします 

### タスク 7：更新プログラムのデプロイをスケジュールする

1.  VM のリストに戻る

1.  ラボで以前に作成した VM を選択する

1.  Update Management をクリックする

1.  スケジュールされた更新のデプロイを選択する

1.  新しいスケジュールされた更新のデプロイで、次の設定を入力する

      - **名** - ScheduledUpdates 
      - **スケジュール設定** -  反復 > 反復

1.  **OK** をクリックしてから、**作成** をクリックする

1.  **デプロイ スケジュール** をクリックして、アクティブな **デプロイ スケジュール** のリストを表示する

### タスク 8：更新プログラムの展開結果を表示する


**注記**：スケジュールされた展開が開始されると、[更新の管理]の下の[更新の展開]タブでその展開の状態を確認できます。展開が現在実行中の場合、ステータスは進行中です。デプロイが完了し、成功すると、ステータスは「成功」に変わります。デプロイ内で 1 つ以上の更新で障害が発生すると、ステータスは部分的に失敗します。


| 警告：続行する前に、このラボで使用したすべてのリソースを削除する必要があります。  **Azure Portal** でこれを行うには、**リソース グループ** をクリックします。  作成したリソース グループを選択します。  リソース グループ ブレードで、**リソース グループを削除**をクリックし、リソース グループ名を入力して、**削除** をクリックします。  作成した可能性のある追加のリソース グループに対してプロセスを繰り返します。**これを行わないと、他のラボで問題が発生する可能性があります。** |
| --- |


**結果**：これで、Azure で Windows サーバーを実行している VM のアラートシステムを使用した、スケジュールされた Windows Update 管理の追加が完了しました

