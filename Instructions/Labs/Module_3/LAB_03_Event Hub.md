---
lab:
    title: 'ラボ 3 - イベント ハブ'
    module: 'モジュール 3：セキュリティ操作の管理'
---

# モジュール 3：ラボ 3 - イベント ハブ


送信アプリケーションと受信アプリケーションを Event Hubs に接続して、データを失うことなく非常に高い負荷を処理できるようにします。

このラボでは、次の内容を学習します。

- Azure portal を使用して Event Hub を作成する
- Event Hub を介してメッセージを送受信するようにアプリケーションを構成する
- Azure portal を使用して Event Hub のパフォーマンスを評価する

## 演習 1：Event Hub の実装

### タスク 1：Event Hubs 名前空間を有効にする

1.  Azure portal にログインします

2.  検索バーに、**Event Hubs** を入力し、**Event Hubs** を選択します

3.  **追加** をクリックし、新しい Event Hubs 名前空間を追加します

  - 次の詳細をフィールドに入力します。

     - **名**：yourUniqueName
     - **価格レベル**：Standard
     - **サブスクリプション**：yourSubscription
     - **リソース グループ**：「EventHubRG」という名前で新規作成する
     - **保存先**: 米国東部
     - **スループット ユニット**：2

4.  **作成** をクリックする

### タスク 2：後に使用するユーザーのためのストレージ アカウントを作成する


**注記**：また、後でイベント ハブに送信されるイベントを保存するために、ストレージ アカウントと BLOB ストア コンテナーを作成する必要があります


1.  検索バーで **ストレージ アカウント** を検索し、**ストレージ アカウント** をクリックする

2.  **追加** をクリックします。
3.  **EventHubsRG** のリソース グループを選択します (または別のリソース グループを使用する場合は、リソース グループの名前)
4.  次のオプションを設定します。

      - **ストレージ アカウント名**：uniqueName (すべての Azure で一意)
      - **保存先**：米国東部
      - **パフォーマンス**: Standard
      - **アカウントの種類**：汎用 v2
      - **レプリケーション**: ローカル冗長ストレージ (LRS)
      - **アクセス階層**: ホット

5.  **レビュー + 作成** をクリックしてから **作成** をクリックします

6.  ストレージ アカウントが **作成** されるのを待ちます
7.  ストレージ アカウントに戻ります
8.  作成したストレージ アカウントを選択します
9.  概要ペインで、**BLOB** をクリックします
10.  **+コンテナー** をクリックします
11.  名前タイプについて、**イベント** をクリックします
12.  **コンテナーへのパブリック アクセス レベル** を設定します
13.  OK をクリックする

### タスク 3：イベント ハブを作成する

1.  Event Hubs に戻り、新しく作成した Event Hub 名前空間の名前をクリックします

2.  イベント ハブの名前空間で、選択ペインの「エンティティ」にある **イベントハブ** をクリックします

3.  **+Event Hub** をクリックします

4.  「イベント」の名前を入力します

5.  **キャプチャー** で **オン** をクリックします

    **注記**：これにより、以前に作成した BLOB ストアへのイベントのダンプが有効になります


6.  **コンテナー** の選択をクリックします

7.  **以前に作成したストレージ アカウント名** を選択します

8.  **以前に作成した Blob Storage 名** を選択します

9.  **選択** をクリックします

10.  **作成** をクリックする

### タスク 4：イベントをイベント ハブに送信できるようにデータを収集する

1.  イベントハブの名前空間で、**共有アクセスポリシー** をクリックします

2.  **RootManageSharedAccessKey** をクリックします

3.  主キーの横にあるクリップボードにコピーアイコンをクリックします

4.  メモ帳を開いて、後で使用するためにそこに貼り付けます 

5.  Event Hubs 名前空間の名前と作成した Event Hub の名前を同じメモ帳ドキュメントにコピーします

**注記**：イベント ハブ システムにデータの一部を入力するために、後で実行されるスクリプトのこの主キーとその他の情報が必要になります


### タスク 5：スクリプトファイルをダウンロードする


次に、イベント ハブに送信するイベントを作成するために使用されるスクリプトをダウンロードします。これにより、イベント ハブと通信するために記述された環境内のアプリケーションまたは他のシステムからデータを受信するイベント ハブをシミュレートします Azure Event Hubs と通信します。スクリプトファイルは godeploy によって開発され、PowerShell ギャラリーで公開されています


1.  **管理者として PowerShell** を開き (PowerShell アイコンを右クリックして)、次のコマンドを実行します

     ```powershell
    install-script get-blobevents, send-blobevents
     ```

**注記**：プロンプトが表示されたら、インストールを確認します。スクリプトファイルがダウンロードされ、PowerShell で使用できるようになりました


### タスク 6：イベント ハブにイベントを送信する


このセクションでは、以前ポータルからコピーされた主キーが必要になります


1.  PowerShell を開きます

2.  次のコマンドを実行します 

     ```powershell
    send-blobevents
     ```

3.  このコマンドにより、次のデータを入力するように求められます。

      - **primaryKey**：        ラボで以前にコピーした主キー
      - **eventhubnamespace**：名前空間の名前
      - **eventhub**：          イベント ハブの名前
      - **numberOfEvents**：    10 (さらに選択できますが、イベント ハブへの送信に時間がかかります)
  

スクリプトから **401 不正なエラー** が発生した場合、コードを実行したマシンのクロックをチェックしてください。godeploy マシンを使用している場合は、UTC に設定する必要があります。時間を修正した場合は、PowerShell シェルを再起動してコードを再実行する必要があります。


**注記**：これにより、ランダム化されたデータとともに一連のイベントがイベント ハブに送信されます。


### タスク 7：EventHub と Blob Storage のイベントをレビューする

1.  Event Hubs と **Event Hubs の名前空間** に戻ります

2.  **Event Hubs** をクリックして、**イベント ハブ** を選択します

3.  概要ペインで、イベント ハブ グラフをレビューして、受信メッセージのデータ スパイクを確認します

4.  **ストレージ アカウント** を検索して開きます

5.  お使いの **イベント ハブ ストレージ アカウント** を選択します

6.  **BLOB** をクリックします

7.  お使いの **BLOB コンテナー** をイベント ストレージ用に開きます

**情報**：ここでは、Event Hubs システムによって作成された生の .avro イベントを確認できます。EventHubs で使用される .avro 形式の詳細については、次の wiki 記事を参照してください。**「https：//en.wikipedia.org/wiki/Apache_Avro」**


### タスク 8：REST クエリから Blob Storage へのイベントをレビューする

1.  **PowerShell** を起動します

2.  **get-blobevents** を実行して、プロンプトが表示されたら次を入力します。

  - **blobName**：ストレージ アカウントの名前
  - **containsterName**：イベントが保存されている BLOB コンテナーの名前
</br>

**注記**：この情報はストレージ アカウントで確認できます。スクリプトは、Blob Storage に REST クエリを作成してストレージ BLOB にあるすべての .avro イベントをリストします。

| 警告：続行する前に、このラボで使用したすべてのリソースを削除する必要があります。  **Azure Portal** でこれを行うには、**リソース グループ** をクリックします。  作成したリソース グループを選択します。  リソース グループ ブレードで、**リソース グループを削除**をクリックし、リソース グループ名を入力して、**削除** をクリックします。  作成した可能性のある追加のリソース グループに対してプロセスを繰り返します。**これを行わないと、他のラボで問題が発生する可能性があります。** |
| --- |


**結果**：これで、このラボは完了し、シリーズの次の実習ラボに進むことができます

