

# モジュール 4：監査ログとレポートを分析する

## 演習 1：SQL データベース監査を開始する

### タスク 0：ラボの設定

1.  **PowerShell** を開き、次のコマンドを実行して、ラボ用のデータベースをデプロイします。

     ```powershell
    start "https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftLearning%2FAZ-500-Azure-Security%2Fmaster%2FAllfiles%2FLabs%2FMod4_Lab03%2Fazuredeploy.json" 
     ```

1.  **リソース グループ** で、「新規作成」をクリックし、デフォルト名「**Mod4Lab3**」 を使用する

1.  デフォルトの設定済み SQL サーバー名を使用できる

1.  **購入** をクリックする 

### タスク 1 - データベースの監査をセットアップする

1.  **リソース グループ** に **移動する**

1.  上記で作成したリソース グループを **選択する** （手順と同じ名前を選択した場合は「**Mod3Lab3**」）

1.  お使いの **SQL サーバー** 名を **クリックする** 

1.  左ペインで監査をクリックする

1.  監査を **オフ** から **オン** に **変更します**。
警告
**注記**：監査ログの書き込み先を選択するオプションが追加されました。


1.  **3つのオプション** である **ストレージ**、**ログ分析**、**イベントハブ** すべてを **選択します**。

1.  **ストレージで**、構成を **クリック** します。

1.  **サブスクリプションをクリック** して、サブスクリプションを選択する

1.  ストレージ アカウントを **クリック** する

1.  ストレージ アカウントの作成で、一意の名前を入力します（**例Mod4Lab3YOURNAME**）

1.  **OK をクリックします**。

1.  検証されたら、**OK** をもう一度クリックします

1.  「ログ分析」で「構成」をクリックします

1.  「新しいワークスペースを作成する」を **クリック** します

1.  次の設定を入力する

     |Log Analytics ワークスペース|サブスクリプション|リソース グループ | 保存先| 価格レベル|
     |-----------------------|------------|---------------|---------|   -------------
     |Mod4Lab3YOURNAME|サブスクリプション|ラボのセットアップで作成した RG|   米国東部 | GB あたり（2018）|

1.  **OK をクリックします**。
警告
**注記**：Azure portal ではこの場所からイベントハブを作成できないため、イベントハブのセットアップには追加の手順が必要である


1.  構成に **イベントハブ** をセットアップするには、**ポータル** の上部にある **Azure Cloud Shell** をクリックします。

1.  次の **Powerhshell コマンド** を **入力** します。

     ```powershell
    New-AzEventHubNamespace -ResourceGroupName Mod4Lab3  -NamespaceName     Mod3Lab4 -Location eastus
     ```

     ```powershell
    New-AzEventHub -ResourceGroupName Mod4Lab3 -NamespaceName Mod3Lab4  -EventHubName Mod3Lab4 -MessageRetentionInDays 3
     ```

1.  これらのコマンドが完了したら、イベントハブで [構成] をクリックします。

1.  以下の情報を **選択** する

     | サブスクリプション|ハブ名前空間|ハブ名| ハブポリシー名|
     |-------------|-------------|--------|----------------|
     |サブスクリプション| Mod3Lab4|mod3lab4|RootManageSharedAccessKey|


1.  **OK をクリックする**

1.  **監査設定** ページで、**保存** をクリックできるようになる

    **結果**：これで、SQL Db の監査が有効になった 


1.  ログにアクセスするには、**SQLデータベース** と **サーバーが常駐する****リソース グループ** に戻る

1.  以前に作成した **Mod3Lab3** ログ分析ワークスペースを **選択** する

1.  ログを **クリック** する

1.  クエリ スペースに次のコードを入力し、**実行をクリック** します。

     ```cli
    Event | where Source  == "MSSQLSERVER" 
     ```

1.  結果は表示されません。以下の警告をお読みください
警告
**注記**：テストデータを使用して新しいデータベースにログを設定しているため、表示可能な最小ログがあります。例でログがどのように表示されるかを示すために、表示するサンプルデータが入力されたサンプルログ分析 Web サイトを使用できます。


### タスク 2 - 監査ログとレポートを分析する

1.  新しい Web ブラウザー タブで **「https：// portal.loganalytics.io / demo」** にアクセスする

1.  クエリ スペースに次のコードを入力し、**実行をクリック** します。

     ```cli
    Event | where Source  == "MSSQLSERVER" 
     ```

1.  ここから、監査ログの例をいくつか展開して、実際のシステムでどのように見えるかを確認できます。

1.  クエリ スペースに次のコードを入力し、**実行をクリック** します。

     ```cli
    Event 
    | where EventLevelName == "Error" 
    | where TimeGenerated > ago(1d) 
    | where Source != "HealthService" 
    | where Source != "Microsoft-Windows-DistributedCOM" 
    | summarize count() by Source
     ```

1.  **チャートをクリックする**

1.  ここから、ログ データをチャートデータとして表示する方法を確認できます。

1.  **積み上げ列** ドロップダウンを **クリック** して、**パイ** を選択する

1.  ここでは、同じデータを異なるチャートとして見ることができる

1.  ウィンドウの右上から、**エクスポートをクリック** して、データを **CSV** としてエクスポートできます。

 ログ分析で使用されるクエリ言語は Kusto クエリ言語と呼ばれ、この言語の完全なドキュメントはこちら **「https://docs.microsoft.com/ja-jp/azure/kusto/query/」** にあります



**結果**：これで、SQL データベースでのログのセットアップが完了し、ログ分析ワークスペースに対してクエリを実行して、生成される監査ログを表示できます


